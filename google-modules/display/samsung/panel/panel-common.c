// SPDX-License-Identifier: GPL-2.0-only
/*
 * panel common utility.
 *
 * Copyright (c) 2022 Google LLC
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */
#include <linux/kernel.h>
#include <linux/module.h>
#include "panel-common.h"

/* the value is multiplied by 1 million, and generated by the script in b/240216847 */
static const u32 gamma_2_2_coef_x_1m[] = {
	0,	1,	3,	5,	9,	13,	18,	24,	32,	40,	49,
	59,	71,	83,	97,	112,	128,	145,	163,	183,	204,	226,
	249,	273,	299,	326,	354,	383,	414,	446,	480,	514,	550,
	588,	627,	667,	708,	751,	795,	840,	887,	936,	985,	1037,
	1089,	1143,	1198,	1255,	1314,	1373,	1434,	1497,	1561,	1627,	1694,
	1762,	1832,	1903,	1976,	2051,	2127,	2204,	2283,	2364,	2446,	2529,
	2614,	2701,	2789,	2879,	2970,	3063,	3157,	3253,	3351,	3450,	3550,
	3653,	3756,	3862,	3969,	4077,	4188,	4299,	4413,	4528,	4645,	4763,
	4883,	5004,	5127,	5252,	5379,	5507,	5636,	5768,	5901,	6035,	6172,
	6310,	6449,	6591,	6734,	6878,	7025,	7173,	7322,	7474,	7627,	7782,
	7938,	8096,	8256,	8418,	8581,	8746,	8913,	9081,	9251,	9423,	9597,
	9772,	9949,	10128,	10309,	10491,	10675,	10861,	11048,	11238,	11429,	11622,
	11816,	12012,	12211,	12410,	12612,	12815,	13021,	13228,	13436,	13647,	13859,
	14073,	14289,	14507,	14726,	14948,	15171,	15396,	15622,	15851,	16081,	16313,
	16547,	16783,	17021,	17260,	17501,	17745,	17989,	18236,	18485,	18735,	18987,
	19241,	19497,	19755,	20015,	20276,	20540,	20805,	21072,	21341,	21611,	21884,
	22159,	22435,	22713,	22993,	23275,	23559,	23845,	24132,	24422,	24713,	25006,
	25302,	25599,	25898,	26198,	26501,	26806,	27112,	27421,	27731,	28043,	28357,
	28673,	28991,	29311,	29633,	29957,	30282,	30610,	30939,	31270,	31604,	31939,
	32276,	32615,	32956,	33299,	33644,	33991,	34340,	34691,	35043,	35398,	35754,
	36113,	36473,	36836,	37200,	37567,	37935,	38305,	38677,	39052,	39428,	39806,
	40186,	40568,	40952,	41338,	41726,	42116,	42508,	42902,	43298,	43696,	44095,
	44497,	44901,	45307,	45715,	46125,	46536,	46950,	47366,	47784,	48204,	48626,
	49049,	49475,	49903,	50333,	50765,	51199,	51635,	52073,	52513,	52954,	53398,
	53844,	54292,	54743,	55195,	55649,	56105,	56563,	57023,	57485,	57950,	58416,
	58884,	59355,	59827,	60302,	60778,	61257,	61737,	62220,	62705,	63192,	63680,
	64171,	64664,	65159,	65656,	66155,	66656,	67160,	67665,	68172,	68682,	69193,
	69707,	70223,	70740,	71260,	71782,	72306,	72832,	73360,	73890,	74423,	74957,
	75493,	76032,	76573,	77115,	77660,	78207,	78756,	79307,	79860,	80415,	80973,
	81532,	82094,	82658,	83223,	83791,	84361,	84933,	85508,	86084,	86662,	87243,
	87826,	88410,	88997,	89586,	90178,	90771,	91366,	91964,	92563,	93165,	93769,
	94375,	94983,	95594,	96206,	96821,	97437,	98056,	98677,	99300,	99925,	100553,
	101182, 101814, 102448, 103084, 103722, 104362, 105004, 105649, 106296, 106945, 107596,
	108249, 108904, 109562, 110221, 110883, 111547, 112213, 112881, 113552, 114225, 114899,
	115576, 116255, 116937, 117620, 118306, 118994, 119684, 120376, 121070, 121767, 122465,
	123166, 123869, 124575, 125282, 125992, 126704, 127418, 128134, 128852, 129573, 130295,
	131020, 131748, 132477, 133209, 133942, 134678, 135416, 136157, 136899, 137644, 138391,
	139140, 139891, 140645, 141401, 142159, 142919, 143681, 144446, 145213, 145982, 146753,
	147527, 148302, 149080, 149861, 150643, 151428, 152214, 153003, 153795, 154588, 155384,
	156182, 156982, 157784, 158589, 159396, 160205, 161016, 161830, 162646, 163464, 164284,
	165107, 165932, 166759, 167588, 168419, 169253, 170089, 170927, 171768, 172611, 173456,
	174303, 175152, 176004, 176858, 177714, 178573, 179434, 180297, 181162, 182030, 182899,
	183772, 184646, 185522, 186401, 187282, 188166, 189052, 189939, 190830, 191722, 192617,
	193514, 194413, 195315, 196219, 197125, 198033, 198944, 199857, 200772, 201690, 202609,
	203532, 204456, 205383, 206312, 207243, 208176, 209112, 210050, 210991, 211933, 212878,
	213826, 214775, 215727, 216681, 217638, 218596, 219557, 220521, 221486, 222454, 223425,
	224397, 225372, 226349, 227329, 228311, 229295, 230281, 231270, 232261, 233254, 234250,
	235248, 236248, 237251, 238256, 239263, 240272, 241284, 242298, 243315, 244334, 245355,
	246378, 247404, 248432, 249463, 250495, 251531, 252568, 253608, 254650, 255694, 256741,
	257790, 258842, 259895, 260951, 262010, 263071, 264134, 265199, 266267, 267337, 268410,
	269484, 270561, 271641, 272723, 273807, 274894, 275982, 277074, 278167, 279263, 280361,
	281462, 282565, 283670, 284778, 285888, 287001, 288115, 289232, 290352, 291474, 292598,
	293724, 294853, 295985, 297118, 298254, 299393, 300533, 301677, 302822, 303970, 305120,
	306273, 307428, 308585, 309745, 310907, 312071, 313238, 314407, 315579, 316753, 317929,
	319108, 320289, 321472, 322658, 323846, 325037, 326230, 327425, 328623, 329823, 331026,
	332231, 333438, 334648, 335860, 337074, 338291, 339510, 340732, 341956, 343183, 344411,
	345643, 346876, 348112, 349351, 350592, 351835, 353080, 354329, 355579, 356832, 358087,
	359345, 360605, 361867, 363132, 364399, 365669, 366941, 368216, 369493, 370772, 372054,
	373338, 374624, 375913, 377205, 378498, 379795, 381093, 382394, 383698, 385004, 386312,
	387623, 388936, 390252, 391570, 392890, 394213, 395538, 396866, 398196, 399529, 400864,
	402201, 403541, 404883, 406228, 407575, 408925, 410277, 411631, 412988, 414347, 415709,
	417073, 418440, 419809, 421181, 422554, 423931, 425310, 426691, 428075, 429461, 430850,
	432241, 433634, 435030, 436428, 437829, 439233, 440638, 442047, 443457, 444870, 446286,
	447704, 449124, 450547, 451973, 453400, 454831, 456263, 457699, 459136, 460576, 462019,
	463464, 464912, 466362, 467814, 469269, 470726, 472186, 473648, 475113, 476580, 478050,
	479522, 480997, 482474, 483953, 485435, 486920, 488407, 489896, 491388, 492883, 494380,
	495879, 497381, 498885, 500392, 501901, 503413, 504927, 506444, 507963, 509485, 511009,
	512536, 514065, 515596, 517130, 518667, 520206, 521748, 523292, 524838, 526387, 527939,
	529493, 531049, 532608, 534170, 535734, 537300, 538869, 540441, 542015, 543591, 545170,
	546751, 548335, 549922, 551511, 553102, 554696, 556293, 557892, 559493, 561097, 562703,
	564312, 565924, 567538, 569154, 570773, 572395, 574019, 575645, 577275, 578906, 580540,
	582177, 583816, 585457, 587102, 588748, 590397, 592049, 593703, 595360, 597019, 598681,
	600345, 602012, 603681, 605353, 607027, 608704, 610384, 612066, 613750, 615437, 617127,
	618819, 620513, 622210, 623910, 625612, 627317, 629024, 630733, 632446, 634161, 635878,
	637598, 639320, 641045, 642772, 644502, 646235, 647970, 649708, 651448, 653191, 654936,
	656683, 658434, 660187, 661942, 663700, 665460, 667223, 668989, 670757, 672528, 674301,
	676077, 677855, 679636, 681419, 683205, 684994, 686785, 688578, 690375, 692173, 693974,
	695778, 697585, 699394, 701205, 703019, 704836, 706655, 708477, 710301, 712128, 713957,
	715789, 717623, 719460, 721300, 723142, 724987, 726834, 728684, 730537, 732392, 734249,
	736109, 737972, 739837, 741705, 743576, 745449, 747324, 749202, 751083, 752966, 754852,
	756741, 758632, 760525, 762421, 764320, 766221, 768125, 770032, 771941, 773852, 775766,
	777683, 779602, 781524, 783449, 785376, 787306, 789238, 791173, 793110, 795050, 796993,
	798938, 800886, 802836, 804789, 806745, 808703, 810663, 812627, 814593, 816561, 818532,
	820506, 822482, 824461, 826442, 828426, 830413, 832402, 834394, 836388, 838385, 840385,
	842387, 844392, 846400, 848410, 850422, 852437, 854455, 856476, 858499, 860524, 862553,
	864583, 866617, 868653, 870691, 872733, 874777, 876823, 878872, 880924, 882978, 885035,
	887095, 889157, 891222, 893289, 895359, 897431, 899507, 901584, 903665, 905748, 907834,
	909922, 912013, 914106, 916202, 918301, 920403, 922507, 924613, 926722, 928834, 930949,
	933066, 935186, 937308, 939433, 941561, 943691, 945824, 947959, 950097, 952238, 954381,
	956527, 958676, 960827, 962981, 965138, 967297, 969458, 971623, 973790, 975960, 978132,
	980307, 982484, 984665, 986848, 989033, 991221, 993412, 995605, 997801, 1000000
};

/**
 * panel_cmn_calc_gamma_2_2_luminance() - calculate prorated luminance based on gamma2.2 curve
 *
 * @value: the input to prorate the luminance on X axis of gamma2.2 curve
 * @max_value: the maximum value on the X axis
 * @nit: the luminance associated with max_value on Y axis
 *
 * Description: luminance = exp(ln(value/max_value) * 2.2) * max_Luminance, gamma_2_2_coef_x_1m
 *              stands for "exp(ln(value/max_value) * 2.2)". The function uses interpolation
 *              method to calculate the prorated luminance.
 *
 * Return: prorated luminance
 */
u32 panel_cmn_calc_gamma_2_2_luminance(const u32 value, const u32 max_value, const u32 nit)
{
	u32 count = ARRAY_SIZE(gamma_2_2_coef_x_1m);
	u32 ratio = mult_frac(value, count, max_value);
	u32 i;

	for (i = 0; i < count; i++) {
		if (ratio >= i && ratio < (i + 1))
			break;
	}
	if (i == count)
		i = count - 1;

	return mult_frac(gamma_2_2_coef_x_1m[i], nit, 1000000);
}
EXPORT_SYMBOL_GPL(panel_cmn_calc_gamma_2_2_luminance);

/**
 * panel_cmn_calc_linear_luminance() - calculate prorated luminance based on linear curve
 *
 * @value: input value to prorate luminance
 * @coef_x_1k: linear coefficient multiplied by 1000
 * @offset: offset value of Y axis
 *
 * Description: luminance = coefficient * value + offset
 *
 * Return: prorated luminance
 */
u32 panel_cmn_calc_linear_luminance(const u32 value, const u32 coef_x_1k, const int offset)
{
	return mult_frac(value, coef_x_1k, 1000) + offset;
}
EXPORT_SYMBOL_GPL(panel_cmn_calc_linear_luminance);

MODULE_AUTHOR("Shiyong Li <shiyongli@google.com>");
MODULE_DESCRIPTION("Google panel common utility");
MODULE_LICENSE("GPL");
